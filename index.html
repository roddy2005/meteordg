<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="theme-color" content="#0b1020" />
  <title>Meteor Dodge</title>
  <style>
    html, body { margin:0; height:100%; background:#0b1020; color:#e6ecff; font-family: system-ui, -apple-system, Segoe UI, Roboto, Noto Sans, Apple SD Gothic Neo, "Malgun Gothic", sans-serif; overscroll-behavior:none; -webkit-touch-callout:none; -webkit-tap-highlight-color:transparent; }
    #ui { position: fixed; inset: 0; pointer-events: none; }
    .hud { position: absolute; left: 12px; top: 12px; display:flex; gap:10px; align-items:center; pointer-events: auto; }
    .card { background: rgba(10,16,40,.7); backdrop-filter: blur(8px); border:1px solid rgba(255,255,255,.08); border-radius: 16px; padding:10px 14px; box-shadow: 0 6px 24px rgba(0,0,0,.4); }
    .btn { pointer-events:auto; appearance: none; border: 1px solid rgba(255,255,255,.2); background: rgba(255,255,255,.06); color:#e6ecff; padding:10px 14px; border-radius:12px; font-weight:600; cursor:pointer; }
    .btn:hover { background: rgba(255,255,255,.12); }
    #centerOverlay { position: absolute; inset: 0; display:flex; align-items:center; justify-content:center; pointer-events:auto; }
    .panel { width:min(92vw, 520px); background: rgba(10,16,40,.85); border:1px solid rgba(255,255,255,.1); border-radius: 20px; padding: 22px; box-shadow: 0 16px 48px rgba(0,0,0,.55); }
    .title { font-size: clamp(24px, 4.5vw, 36px); font-weight: 800; margin: 0 0 8px; letter-spacing: .5px; }
    .muted { opacity:.8; font-size:14px; }
    .row { display:flex; gap: 10px; align-items:center; flex-wrap: wrap; }
    .grow { flex:1 1 auto; }
    input[type="text"] { width: 100%; background: rgba(255,255,255,.06); border:1px solid rgba(255,255,255,.18); color:#e6ecff; padding:10px 12px; border-radius: 12px; outline: none; font-size: 16px; }
    ol { margin: 8px 0 0 20px; padding:0; }
    #leaderboard { max-height: 200px; overflow:auto; }
    #footer { position: absolute; right: 12px; bottom: 12px; opacity:.7; font-size: 12px; padding-bottom: env(safe-area-inset-bottom); }
    canvas { display:block; touch-action: none; }
  </style>
</head>
<body>
  <canvas id="game"></canvas>
  <div id="ui">
    <div class="hud">
      <div class="card" id="scoreCard">점수 <b id="score">0</b></div>
      <button class="btn" id="pauseBtn" aria-label="일시정지">⏸︎</button>
    </div>
    <div id="centerOverlay">
      <div class="panel">
        <h1 class="title" id="overlayTitle">Meteor Dodge</h1>
        <p class="muted" id="overlayDesc">손가락을 대고 비행선을 움직여 운석을 피하세요. 시간이 지날수록 더 어려워집니다.</p>

        <div id="gameOverBlock" hidden>
          <p style="margin:.5rem 0 0">이번 점수: <b id="finalScore">0</b></p>
          <div class="row" style="margin-top:10px">
            <input id="nickname" type="text" maxlength="16" placeholder="닉네임" class="grow" />
            <button id="saveBtn" class="btn">랭킹 등록</button>
          </div>
          <p class="muted" id="saveStatus" style="min-height:1.2em"></p>
        </div>

        <div style="display:flex; gap:12px; margin-top:12px; flex-wrap:wrap">
          <button id="startBtn" class="btn" style="font-size:18px">▶ 시작</button>
          <button id="restartBtn" class="btn" hidden>다시 시작</button>
        </div>

        <h3 style="margin:16px 0 6px">🏆 실시간 랭킹 Top 10</h3>
        <div id="leaderboard" class="card" style="padding:12px">
          <ol id="lbList"></ol>
        </div>
      </div>
    </div>
    <div id="footer">Made for mobile · 드래그/터치 조작</div>
  </div>

  <script type="module">
    import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm";

    // 1) 여기에 본인 프로젝트 값 채우기 (환경변수 권장)
    const SUPABASE_URL = "https://hgjdlqqhvgwzszwwnlpr.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhnamRscXFodmd3enN6d3dubHByIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUxMzU4MDEsImV4cCI6MjA3MDcxMTgwMX0.yveInn8yTSH3325zIJ6wKjH72JyrKZBvaTngEuKDNJY";

    // 2) Supabase 클라이언트 (플레이스홀더면 비활성화)
    const hasCreds =
      SUPABASE_URL.startsWith('http') &&
      !SUPABASE_URL.includes('REPLACE') &&
      SUPABASE_ANON_KEY &&
      !SUPABASE_ANON_KEY.includes('REPLACE');

    const sb = hasCreds ? createClient(SUPABASE_URL, SUPABASE_ANON_KEY) : null;

    // DOM
    const canvas = document.getElementById('game');
    const ctx = canvas.getContext('2d');
    const scoreEl = document.getElementById('score');
    const pauseBtn = document.getElementById('pauseBtn');
    const overlay = document.getElementById('centerOverlay');
    const startBtn = document.getElementById('startBtn');
    const restartBtn = document.getElementById('restartBtn');
    const overlayTitle = document.getElementById('overlayTitle');
    const overlayDesc = document.getElementById('overlayDesc');
    const gameOverBlock = document.getElementById('gameOverBlock');
    const finalScoreEl = document.getElementById('finalScore');
    const nicknameInput = document.getElementById('nickname');
    const saveBtn = document.getElementById('saveBtn');
    const saveStatus = document.getElementById('saveStatus');
    const lbList = document.getElementById('lbList');

    // 캔버스 크기 & DPR (iOS 주소창/노치 대응: visualViewport 활용)
    const state = {
      w: 0, h: 0, dpr: 1,
      running: false, paused: false,
      time: 0, score: 0, lastSpawn: 0, spawnInterval: 1000,
      meteors: [],
      pointer: { active:false, x:0, y:0 },
      ship: { x:0, y:0, r: 18, speed: 0.18 },
    };

    function fit() {
      const dpr = Math.min(window.devicePixelRatio || 1, 2);
      const vw = window.visualViewport ? Math.floor(window.visualViewport.width) : window.innerWidth;
      const vh = window.visualViewport ? Math.floor(window.visualViewport.height) : window.innerHeight;
      state.w = vw; state.h = vh; state.dpr = dpr;
      canvas.width = Math.floor(state.w * dpr);
      canvas.height = Math.floor(state.h * dpr);
      canvas.style.width = state.w + 'px';
      canvas.style.height = state.h + 'px';
      ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
    }
    window.addEventListener('resize', fit);
    if (window.visualViewport) {
      window.visualViewport.addEventListener('resize', fit);
      window.visualViewport.addEventListener('scroll', fit);
    }
    fit();

    // 입력 (터치 스크롤/풀투리프레시 방지)
    function setPointer(e){
      const rect = canvas.getBoundingClientRect();
      const x = (e.clientX ?? (e.touches?.[0]?.clientX || 0)) - rect.left;
      const y = (e.clientY ?? (e.touches?.[0]?.clientY || 0)) - rect.top;
      state.pointer.x = Math.max(0, Math.min(state.w, x));
      state.pointer.y = Math.max(0, Math.min(state.h, y));
    }
    canvas.addEventListener('pointerdown', e=>{ state.pointer.active=true; setPointer(e); });
    canvas.addEventListener('pointermove', e=>{ if(state.pointer.active) setPointer(e); });
    window.addEventListener('pointerup', ()=>{ state.pointer.active=false; });

    canvas.addEventListener('touchstart', e=> e.preventDefault(), {passive:false});
    canvas.addEventListener('touchmove', e=> e.preventDefault(), {passive:false});
    document.addEventListener('touchmove', (e)=>{
      if(e.target === document.body || e.target === canvas) e.preventDefault();
    }, {passive:false});

    // 유틸 & 스폰
    const rand = (a,b)=> a + Math.random()*(b-a);
    function spawnMeteor() {
      const edge = (Math.random()*4)|0;
      const size = rand(10, 28);
      let x,y;
      if(edge===0){ x = rand(0, state.w); y = -size-2; }
      else if(edge===1){ x = state.w+size+2; y = rand(0, state.h); }
      else if(edge===2){ x = rand(0, state.w); y = state.h+size+2; }
      else { x = -size-2; y = rand(0, state.h); }
      const targetX = state.ship.x + rand(-80,80);
      const targetY = state.ship.y + rand(-80,80);
      const dx = targetX - x; const dy = targetY - y; const len = Math.hypot(dx,dy) || 1;
      const baseSpeed = 90 + (state.time * 0.015);
      const vx = dx/len * baseSpeed; const vy = dy/len * baseSpeed;
      state.meteors.push({ x,y, r:size, vx, vy });
    }

    function resetGame() {
      state.time = 0; state.score = 0; state.lastSpawn = 0; state.spawnInterval = 900;
      state.meteors.length = 0;
      state.ship.x = state.w*0.5; state.ship.y = state.h*0.7;
      state.pointer.x = state.ship.x; state.pointer.y = state.ship.y;
    }

    function startGame() {
      overlay.hidden = true;
      gameOverBlock.hidden = true;
      state.running = true; state.paused = false;
      resetGame();
      if (screen.orientation && screen.orientation.lock) {
        screen.orientation.lock('portrait').catch(()=>{});
      }
    }

    function gameOver() {
      state.running = false;
      overlay.hidden = false;
      overlayTitle.textContent = '게임 종료';
      overlayDesc.textContent = '운석과 충돌했습니다. 닉네임을 입력하고 랭킹에 등록해보세요!';
      gameOverBlock.hidden = false;
      finalScoreEl.textContent = state.score.toString();
      restartBtn.hidden = false; startBtn.hidden = true;
      nicknameInput.value = localStorage.getItem('md.nickname') || '';
      nicknameInput.focus();
      fetchLeaderboard();
    }

    function togglePause() {
      if(!state.running) return;
      state.paused = !state.paused;
      pauseBtn.textContent = state.paused ? '▶' : '⏸︎';
      if(!state.paused) lastTs = performance.now();
    }
    pauseBtn.addEventListener('click', togglePause);
    startBtn.addEventListener('click', startGame);
    restartBtn.addEventListener('click', ()=>{ startBtn.hidden = true; startGame(); });

    // 리더보드
    async function fetchLeaderboard(){
      lbList.innerHTML = '<li class="muted">불러오는 중...</li>';
      if(!sb){ lbList.innerHTML = '<li class="muted">저장소가 설정되지 않아 랭킹을 불러올 수 없습니다.</li>'; return; }
      const { data, error } = await sb.from('scores')
        .select('nickname, score, created_at')
        .order('score', { ascending:false })
        .limit(10);
      if(error){ lbList.innerHTML = `<li class="muted">오류: ${error.message}</li>`; return; }
      lbList.innerHTML = '';
      (data||[]).forEach((row, i)=>{
        const li = document.createElement('li');
        li.textContent = `${i+1}. ${row.nickname} — ${row.score}`;
        lbList.appendChild(li);
      });
      if((data||[]).length===0){
        lbList.innerHTML = '<li class="muted">아직 점수가 없습니다. 첫 기록의 주인공이 되어보세요!</li>';
      }
    }

    async function saveScore(){
      const nick = (nicknameInput.value||'').trim().slice(0,16);
      if(!nick){ saveStatus.textContent = '닉네임을 입력하세요.'; return; }
      if(!sb){ saveStatus.textContent = '저장소가 설정되지 않아 저장할 수 없습니다.'; return; }
      const payload = { nickname: nick, score: state.score };
      saveBtn.disabled = true; saveStatus.textContent = '저장 중...';
      const { error } = await sb.from('scores').insert(payload);
      if(error){ saveStatus.textContent = '실패: '+error.message; saveBtn.disabled=false; return; }
      localStorage.setItem('md.nickname', nick);
      saveStatus.textContent = '저장 완료!';
      fetchLeaderboard();
    }
    saveBtn.addEventListener('click', saveScore);

    // 초기 오버레이 & 랭킹 로드
    overlay.hidden = false; fetchLeaderboard();

    // 렌더링
    function drawShip(){
      const { x, y, r } = state.ship;
      ctx.save(); ctx.translate(x,y);
      ctx.beginPath(); ctx.moveTo(0, -r*1.2); ctx.lineTo(r*0.8, r*1.0); ctx.lineTo(-r*0.8, r*1.0); ctx.closePath();
      ctx.fillStyle = '#8cc9ff'; ctx.shadowColor = '#6bd1ff'; ctx.shadowBlur = 16; ctx.fill(); ctx.shadowBlur = 0;
      ctx.beginPath(); ctx.moveTo(0, r*1.0); ctx.lineTo(r*0.35, r*1.7); ctx.lineTo(-r*0.35, r*1.7); ctx.closePath();
      ctx.fillStyle = '#ffd166'; ctx.fill(); ctx.restore();
    }

    function drawMeteor(m){
      const g = ctx.createRadialGradient(m.x, m.y, m.r*0.2, m.x, m.y, m.r);
      g.addColorStop(0, '#e86'); g.addColorStop(1, '#a42');
      ctx.fillStyle = g; ctx.beginPath(); ctx.arc(m.x, m.y, m.r, 0, Math.PI*2); ctx.fill();
    }

    function update(dt){
      state.time += dt;
      const targetInterval = Math.max(220, 900 - state.time * 0.2);
      state.spawnInterval += (targetInterval - state.spawnInterval)*0.05;
      if(state.time - state.lastSpawn > state.spawnInterval){
        state.lastSpawn = state.time;
        const batch = Math.random() < Math.min(0.6, state.time/20000) ? 2 : 1;
        for(let i=0;i<batch;i++) spawnMeteor();
      }
      state.score = Math.floor(state.time/100);
      state.ship.x += (state.pointer.x - state.ship.x) * state.ship.speed;
      state.ship.y += (state.pointer.y - state.ship.y) * state.ship.speed;
      for(const m of state.meteors){ m.x += m.vx * dt/1000; m.y += m.vy * dt/1000; }
      const margin = 80;
      state.meteors = state.meteors.filter(m => m.x>-margin && m.x<state.w+margin && m.y>-margin && m.y<state.h+margin);
      for(const m of state.meteors){
        const dx = m.x - state.ship.x, dy = m.y - state.ship.y;
        if(dx*dx + dy*dy < (m.r + state.ship.r*0.9)**2){ gameOver(); break; }
      }
    }

    function render(){
      ctx.clearRect(0,0,state.w,state.h);
      for(let i=0;i<16;i++){
        const x = ((i*127 + (state.time*0.02)) % state.w);
        const y = (i*73) % state.h;
        ctx.fillStyle = 'rgba(200,220,255,.15)'; ctx.fillRect(x, y, 2, 2);
      }
      for(const m of state.meteors) drawMeteor(m);
      drawShip();
      scoreEl.textContent = state.score.toString();
    }

    let lastTs = performance.now();
    function loop(ts){
      if(!state.running){ requestAnimationFrame(loop); return; }
      const dt = Math.min(32, ts - lastTs); lastTs = ts;
      if(!state.paused){ update(dt); render(); }
      requestAnimationFrame(loop);
    }
    requestAnimationFrame(loop);

    overlayTitle.textContent = 'Meteor Dodge';
    overlayDesc.textContent = '터치를 누르고 드래그하면 비행선이 따라옵니다. 운석을 피해 오래 살아남으세요!';

  </script>

  <!-- (선택) PWA 설치를 원하면 HTTPS 배포 후 아래 두 파일을 함께 올리세요. -->
  <!-- manifest.json
  {
    "name": "Meteor Dodge",
    "short_name": "Meteor",
    "start_url": ".",
    "display": "standalone",
    "background_color": "#0b1020",
    "theme_color": "#0b1020",
    "icons": [
      { "src": "icon-192.png", "sizes": "192x192", "type": "image/png" },
      { "src": "icon-512.png", "sizes": "512x512", "type": "image/png" }
    ]
  }
  -->
  <!-- sw.js
  const CACHE = 'md-v1';
  self.addEventListener('install', e=>{
    e.waitUntil(caches.open(CACHE).then(c=>c.addAll(['./','./index.html'])));
  });
  self.addEventListener('fetch', e=>{
    e.respondWith(caches.match(e.request).then(r=> r || fetch(e.request)));
  });
  -->
</body>
</html>
